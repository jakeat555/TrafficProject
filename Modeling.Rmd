---
title: "Modeling"
author: "Jacob Johns"
date: "2023-11-03"
output: html_document
---

# Modeling

## Initialize Document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(car)
library(MLmetrics)
```

## Read In Data

```{r}
traffic = read.csv("DenTraffic2019ToModel.csv")
traffic$SEGMDIR = as.factor(traffic$SEGMDIR)
traffic$FUNCCLASSI = as.factor(traffic$FUNCCLASSI)
traffic = subset(traffic, select = -c(X))
```

## Linear Model 1 - All Features, No Interactions

interaction of road size and number of lanes

```{r}
mod1 = lm(AADT ~ SEG_LENGTH + I(SEGMDIR) + I(FUNCCLASSI) + SURFWD + PSI + THRULNQTY + THRULNWD + RUNLENGTH1, data = traffic)
summary(mod1)
```

The only features for which we **don't** have overwhelming evidence are effective in predicting $\verb|AADT|$ are $\verb|SEG_LENGTH|$ , some directions of $\verb|SEGDIR|$ , $\verb|PSI|$ , $\verb|THRULNWD|$ and $\verb|RUNLENGTH1|$ .

### VIF

This checks for collinearity in our features. This statistic is on a scale that starts at 1, and lower values are indicative of no collinearity.

```{r}
vif(mod1)
```

None of these features are of concern. This supports the conclusion we started to come to with the correlation heat-map to keep each feature in our first model.

### ANOVAs

Based off our the significant levels from our model, we will run an ANOVA test to see if the features just mentioned help the model enough to keep them in. We will omit them in if the p-score associated with their F-statistic is greater than 0.05.

```{r}
mod1thin = lm(AADT ~ I(SEGMDIR) + I(FUNCCLASSI) + SURFWD + THRULNQTY, data = traffic)
anova(mod1thin,mod1)
```

An F-statistic of 0.99 and p-value of 0.41 indicates we don't need to keep any of $\verb|SEG_LENGTH|$ , $\verb|PSI|$ , $\verb|THRULNWD|$ nor $\verb|RUNLENGTH1|$ in the model.

```{r}
mod1sansDIR = lm(AADT ~ SEG_LENGTH + I(FUNCCLASSI) + SURFWD + PSI + THRULNQTY + THRULNWD + RUNLENGTH1, data = traffic)
anova(mod1sansDIR,mod1)
```

An F-statistic of 20.388 and p-value of 2.2e-16 indicates we should keep $\verb|SEGMDIR|$ in the model. This warrants more discussion though, as many of the individual directions didn't have a significant impact on the model. There isn't any science to support that the direction of travel would affect the average daily traffic. Furthermore, in conjunction with our visualization of the miles of road in each direction in Denver, there is evidence to suggest this data is not useful for predicting $\verb|AADT|$ . Accordingly, we will remove it.

## Linear Model 2 - Some Features, No Interactions

```{r}
mod2 = lm(AADT ~ I(FUNCCLASSI) + SURFWD + THRULNQTY , data = traffic)
summary(mod2)
```

### Model Validity

We want to show that a linear model is a good type of model for this interaction. On the residual plot below, this is indicated by the points being symmetrically distributed above and below the value of 0. Furthermore, the residual points should be uniform and not fan out to ensure our model has equal variance of residuals.

```{r}
plot(mod2$residuals)
```

Although this isn't perfect, there isn't anything so egregious to justify not using a linear model.

We also want our model to be normally distributed, which on the Q-Q plot below would look like a straight 45 degree line.

```{r}
plot(mod2,which=2)
```

Like before, this isn't perfect, but given that there are over 6000 observations, it is not unexpected to see at least some theoretical quantiles fall below -4 or above 4.

## Outliers

```{r}
outliers = outlierTest(mod2)
subset(traffic,rownames(traffic)%in%names(outliers$rstudent))
```

So our only outlines were 6th Ave, Peoria, and were 1ST meets Speer. These are all larger streets. 1st Street is particularly impressive, with only 3 lanes and an $\verb|AADT|$ of 52000. In an effort to better model smaller streets, we acknowledge that these outliers are skewing the linear model and affecting the model. We will also try a model without these observations for thoroughness.

```{r}
traffic = subset(traffic,!rownames(traffic)%in%names(outliers$rstudent))
```

## Linear Model 3 - Some Features, No Outliers, No Interactions

```{r}
mod3 = lm(AADT ~ I(FUNCCLASSI) + SURFWD + THRULNQTY , data = traffic)
summary(mod3)
```

## Interactions

It is also important to consider how features interact with each other. For example, dividing the width of lanes by the inverse of lane quantity can be considered some sort of density. Or, given that there is a lot of time spent in acceleration, and deceleration, it would be understandable if the length of the run had a cubic interaction to account for saved time and ease of flow on longer stretches.

## Linear Model 4 - Some Features, No Outliers, Interactions

```{r}
mod4 = lm(AADT ~ I(FUNCCLASSI) + SURFWD + THRULNWD/1/THRULNQTY + I(RUNLENGTH1^3), data = traffic)
summary(mod4)
```

## Verification

```{r}
trafficTest = read.csv("DenTraffic2019Test.csv")
y_pred = predict(mod1, type = 'response', newdata = trafficTest)
MAPE(y_pred=y_pred, y_true = trafficTest$AADT)
```

```{r}
NormalizedGini(y_pred=y_pred, y_true = trafficTest$AADT)
```

```{r}
goodPreds = y_pred > .9*trafficTest$AADT & y_pred < 1.1*trafficTest$AADT
sum(goodPreds)/length(y_pred)
```

Hmm these two results don't seem too promising. It looks like only about 21% of predictions were within 10% of the real world value. Furthermore, an mean absolute percentage error of 74% indicates that the model does quite poorly, but the normalized GINI coefficient of 0.83 indicates that our model does well *given its circumstances*. These values shouldn't change much for our different models though, so we'll only show the statistics for the 4th model.

```{r}
y_pred = predict(mod4, type = 'response', newdata = trafficTest)
MAPE(y_pred=y_pred, y_true = trafficTest$AADT)
```

```{r}
NormalizedGini(y_pred=y_pred, y_true = trafficTest$AADT)
```

```{r}
goodPreds = y_pred > .9*trafficTest$AADT & y_pred < 1.1*trafficTest$AADT
sum(goodPreds)/length(y_pred)
```

Nothing changes that much. Our models are very similar and had similar $R^2$ scores so it's very understandable that they performed similarly.

## Export Models

```{r}
saveRDS(mod1,"model1Full")
saveRDS(mod3,"model3Limited")
saveRDS(mod4,"model4Inter")
```

```{r}
library(plotly)

fig <- plot_ly(traffic, x = ~AADT, y = ~SURFWD, z = ~THRULNQTY, type = 'scatter3d',color=traffic$FUNCCLASSI, opacity = 1, mode= "marker")

fig
```
